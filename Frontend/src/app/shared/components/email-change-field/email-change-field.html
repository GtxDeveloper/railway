<div class="flex flex-col">
  <span class="ml-6 md:ml-10 mt-2 text-white text-sm md:text-base font-bold raleway">
    {{ 'EMAIL_CHANGE.LABEL' | translate }}
  </span>

  <div
    class="group relative w-full bg-white px-5 py-3 md:px-6 md:py-4 rounded-full border-3 border-transparent hover:border-[#ffc800]/50 transition-all cursor-pointer shadow-sm"
    (click)="openEdit()"
  >
    <div class="raleway font-medium text-lg md:text-2xl text-gray-700 truncate pr-12 md:pr-20">
      {{ currentEmail || ('EMAIL_CHANGE.PLACEHOLDER_CURRENT' | translate) }}
    </div>

    <span class="absolute right-5 md:right-6 top-1/2 -translate-y-1/2 text-[#ffc800] font-bold raleway text-sm md:text-lg opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300">
      {{ 'EMAIL_CHANGE.CHANGE_BUTTON' | translate }}
    </span>
  </div>
</div>

@if (isOpen()) {
  <div class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">

    <div class="bg-[#27a19b] w-full max-w-lg p-6 md:p-8 rounded-[30px] md:rounded-[40px] shadow-2xl relative flex flex-col gap-4 md:gap-6" (click)="$event.stopPropagation()">

      <h2 class="text-2xl md:text-3xl text-white font-bold text-center raleway">
        @if (step() === 'email') {
          {{ 'EMAIL_CHANGE.MODAL_TITLE_EMAIL' | translate }}
        } @else {
          {{ 'EMAIL_CHANGE.MODAL_TITLE_CODE' | translate }}
        }
      </h2>

      @if (step() === 'email') {
        <div class="flex flex-col gap-1 animate-slide-in">
          <span class="ml-5 text-white text-sm font-bold raleway">
            {{ 'EMAIL_CHANGE.NEW_EMAIL_LABEL' | translate }}
          </span>
          <input
            type="email"
            [formControl]="emailControl"
            [placeholder]="'EMAIL_CHANGE.NEW_EMAIL_PLACEHOLDER' | translate"
            class="w-full bg-white px-4 py-3 md:px-5 md:py-6 rounded-full raleway font-medium text-lg md:text-2xl border-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
            [ngClass]="{
              'border-red-500 focus:ring-red-200': emailControl.invalid && emailControl.touched,
              'border-[#ffc800]': emailControl.valid && emailControl.touched,
              'border-white': !emailControl.touched || (emailControl.valid && !emailControl.touched)
            }"
          />
          @if (emailControl.invalid && emailControl.touched) {
            <span class="font-bold text-xs ms-5 md:ms-7 raleway text-red-100">
              {{ 'EMAIL_CHANGE.ERROR_FORMAT' | translate }}
            </span>
          }
        </div>

        <div class="flex gap-3 md:gap-4 mt-2">
          <button (click)="cancel()" class="flex-1 py-3 md:py-4 rounded-full bg-white text-[#27a19b] font-bold text-lg md:text-xl raleway hover:bg-gray-100">
            {{ 'EMAIL_CHANGE.CANCEL' | translate }}
          </button>
          <button
            (click)="submitEmail()"
            [disabled]="isLoading()"
            class="flex-1 py-3 md:py-4 rounded-full bg-[#ffc800] text-black font-bold text-lg md:text-xl raleway hover:bg-[#e6b400] shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
            {{ isLoading() ? ('EMAIL_CHANGE.SENDING' | translate) : ('EMAIL_CHANGE.SEND_CODE' | translate) }}
          </button>
        </div>
      }

      @if (step() === 'otp') {
        <div class="flex flex-col items-center gap-4 animate-slide-in">
          <p class="text-white raleway text-center opacity-90">
            {{ 'EMAIL_CHANGE.CODE_SENT_TO' | translate }} <br>
            <span class="font-bold text-[#ffc800]">{{ emailControl.value }}</span>
          </p>

          <div class="flex justify-center gap-2 md:gap-3 w-full">
            @for (digit of digits; track i; let i = $index) {
              <input
                #otpInput
                type="text"
                inputmode="numeric"
                maxlength="1"
                [(ngModel)]="digits[i]"
                (input)="onInput(i, $event)"
                (keydown)="onKeyDown(i, $event)"
                (paste)="onPaste($event)"
                class="w-10 h-12 md:w-14 md:h-16 rounded-xl text-center text-2xl md:text-3xl font-bold text-gray-900 bg-white border-3 border-transparent outline-none transition-all duration-200 focus:border-[#ffc800] focus:ring-4 focus:ring-[#ffc800]/30 focus:-translate-y-1 shadow-lg"
              >
            }
          </div>

          <div class="flex gap-3 md:gap-4 mt-4 w-full">
            <button (click)="step.set('email')" class="flex-1 py-3 md:py-4 rounded-full bg-white/20 text-white font-bold text-lg md:text-xl raleway hover:bg-white/30">
              {{ 'EMAIL_CHANGE.BACK' | translate }}
            </button>
            <button (click)="verifyCode()" class="flex-1 py-3 md:py-4 rounded-full bg-[#ffc800] text-black font-bold text-lg md:text-xl raleway hover:bg-[#e6b400] shadow-lg">
              {{ 'EMAIL_CHANGE.CONFIRM' | translate }}
            </button>
          </div>
        </div>
      }

    </div>
  </div>
}
